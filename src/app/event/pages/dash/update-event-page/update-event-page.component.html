<div class="min-h-screen w-full p-4 lg:p-8 bg-base-100 text-base-content">
    <shared-header-back title="Actualizar Evento" (back)="goBack()"></shared-header-back>

    <form [formGroup]="updateEventForm" (ngSubmit)="onSubmit()" class="w-full space-y-8">

        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start bg-base-100/50 p-6 rounded-xl shadow-md">
            <div class="lg:col-span-2">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Información General</h2>

                <div class="space-y-4">
                    <label class="block">
                        <span class="text-sm font-medium">Nombre del evento</span>
                        <input formControlName="name" type="text" placeholder="Nombre del evento" class="input input-bordered w-full mt-1" />
                    </label>

                    <label class="block">
                        <span class="text-sm font-medium">Descripción</span>
                        <textarea formControlName="description" rows="4" placeholder="Descripción breve" class="textarea textarea-bordered w-full mt-1 resize-none"></textarea>
                    </label>

                    <div class="grid grid-cols-1 md:grid-cols-2">
                        <label class="block">
                            <span class="text-sm font-medium">Codigo Postal</span>
                            <input formControlName="postalCode" type="text" placeholder="Código postal" class="input input-bordered w-full mt-1" />
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium">Estado / Provincia </span>
                            <input formControlName="state" type="text" placeholder="Estado" class="input input-bordered w-full mt-1" />
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium">Ciudad</span>
                            <input formControlName="city" type="text" placeholder="Ciudad" class="input input-bordered w-full mt-1" />
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium">Dirección</span>
                            <input formControlName="location" type="text" placeholder="Lugar o dirección" class="input input-bordered w-full mt-1" />
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium">Ubicación</span>
                            <input formControlName="ubication" type="text" placeholder="Lugar o dirección" class="input input-bordered w-full mt-1" />
                        </label>

                    </div>


                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="block">
                            <span class="text-sm font-medium">Fecha</span>
                            <input formControlName="date" type="date" class="input input-bordered w-full mt-1" />
                        </label>

                        <label class="block">
                            <span class="text-sm font-medium">Hora</span>
                            <input formControlName="time" type="time" class="input input-bordered w-full mt-1" />
                        </label>
                    </div>

                    <label class="block">
                        <span class="text-sm font-medium">Tipo</span>
                        <select formControlName="type" class="select select-bordered w-full mt-1">
                            <option value="Gratis">Gratis</option>
                            <option value="Pago">Pago</option>
                        </select>
                    </label>
                </div>
            </div>

            <div class="lg:col-span-1 flex flex-col items-stretch">
                <div class="mb-6 w-full">
                    <button type="submit" class="btn btn-primary w-full" [disabled]="!hasChanges() || !isLoaded()">Actualizar Evento</button>
                </div>

                <h3 class="text-lg font-medium mb-3">Imagen del Evento</h3>
                <div class="border border-dashed rounded-lg p-3 flex flex-col items-center gap-3 bg-base-200">
                    <div class="w-full h-56 bg-base-300 rounded-md overflow-hidden flex items-center justify-center relative">
                        @if (imagePreview()) {
                            <img [src]="imagePreview()" alt="preview" class="w-full h-full object-cover" />
                            <div class="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded">Imagen actual</div>
                        }
                        @if (!imagePreview()) {
                            <div class="text-sm text-neutral">No hay previsualización</div>
                        }
                    </div>

                    <input type="file" accept="image/*" (change)="onFileChange($event)" class="file-input file-input-bordered w-full" />
                    <p class="text-xs text-muted">Formatos permitidos: JPG, PNG, GIF. Tamaño máximo: 2MB</p>
                </div>
            </div>
        </section>

        <!-- Boletos -->
        <section class="bg-base-100 rounded-xl p-6 shadow-md">
            <h2 class="text-xl font-semibold mb-3">Boletos</h2>
            <div class="text-sm text-neutral mb-3">El tipo de evento determina los tipos de boleto que se pueden configurar.</div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label class="block text-sm">Tipo de Evento</label>
                    <select formControlName="type" class="select select-bordered w-full mt-1">
                        <option value="Gratis">Gratis</option>
                        <option value="Pago">Pago</option>
                    </select>
                </div>

                <div class="md:col-span-2 flex items-center justify-between">
                    <button type="button" class="btn btn-outline btn-sm" (click)="addTicketType()">+ Agregar tipo</button>
                    <div class="text-xs text-neutral">Para eventos gratis se crea automáticamente un boleto único con precio 0.</div>
                </div>
            </div>

            <div formArrayName="ticketTypes" class="space-y-3 mt-4">
                @for (ticket of ticketTypes.controls; track $index) {
                    <div [formGroupName]="$index" class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-md flex flex-wrap items-center gap-4">
                        <div class="flex-1 min-w-[150px]">
                            <span class="text-xs font-semibold text-gray-500">{{ (ticket.value?.ticketTypeId) ? ('ID: ' + ticket.value.ticketTypeId) : 'NUEVO' }}</span>
                            <input [value]="ticket.value?.name" (input)="updateTicket($index, 'name', $event)" placeholder="Nombre del Ticket" type="text" class="w-full text-lg font-semibold bg-transparent border-b border-indigo-200 focus:outline-none" />
                        </div>

                        <div class="w-24">
                            <label class="block text-xs font-medium text-gray-500">Precio ($)</label>
                            <input [value]="ticket.value?.price" (input)="updateTicket($index, 'price', $event)" type="number" min="0" class="w-full p-1 border rounded text-right" [readonly]="(updateEventForm.get('type')?.value === 'Gratis') && $index === 0" />
                        </div>

                        <div class="w-24">
                            <label class="block text-xs font-medium text-gray-500">Disp.</label>
                            <input [value]="ticket.value?.availableQuantity" (input)="updateTicket($index, 'availableQuantity', $event)" type="number" min="0" class="w-full p-1 border rounded text-right" />
                        </div>

                        <div class="w-24 text-center">
                            <label class="block text-xs font-medium text-gray-500">Vendidos</label>
                            <p class="font-bold text-sm text-indigo-700">{{ getTicketSoldQuantity($index) }}</p>
                        </div>

                        <button type="button" (click)="removeTicket($index)" [disabled]="!!ticket.value?.ticketTypeId" [attr.title]="ticket.value?.ticketTypeId ? 'No se puede eliminar este ticket' : 'Eliminar Ticket'" class="p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition disabled:opacity-50" aria-label="Eliminar Ticket">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                }
            </div>
        </section>

        <!-- Productos -->
        <section class="bg-base-100 rounded-xl p-6 shadow-md">
            <h2 class="text-xl font-semibold mb-3">Productos</h2>

            <div formArrayName="products" class="space-y-3">
                @for (product of products.controls; track $index) {
                    <div [formGroupName]="$index" class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded-md flex flex-wrap items-center gap-4">
                        <div class="flex-1 min-w-[150px]">
                            <span class="text-xs font-semibold text-gray-500">{{ (product.value?.productId) ? ('ID: ' + product.value.productId) : 'NUEVO' }}</span>
                            <input [value]="product.value?.name" (input)="updateProduct($index, 'name', $event)" placeholder="Nombre del Producto" type="text" class="w-full text-lg font-semibold bg-transparent border-b border-purple-200 focus:outline-none" />
                        </div>

                        <div class="w-24">
                            <label class="block text-xs font-medium text-gray-500">Precio ($)</label>
                            <input [value]="product.value?.price" (input)="updateProduct($index, 'price', $event)" type="number" min="0" class="w-full p-1 border rounded text-right" />
                        </div>

                        <div class="w-24">
                            <label class="block text-xs font-medium text-gray-500">Stock</label>
                            <input [value]="product.value?.stock" (input)="updateProduct($index, 'stock', $event)" type="number" min="0" class="w-full p-1 border rounded text-right" />
                        </div>

                        <div class="w-40">
                            <label class="block text-xs font-medium text-gray-500">Imagen</label>
                            <input type="file" accept="image/*" (change)="onProductFileChange($event, $index)" class="file-input file-input-bordered w-full mt-1" />
                            @if (productPreviews[$index]) {
                                <img [src]="productPreviews[$index]" class="w-24 h-24 object-cover mt-2 rounded" />
                            }
                        </div>

                        <button type="button" (click)="removeProduct($index)" [disabled]="!!product.value?.productId" [attr.title]="product.value?.productId ? 'No se puede eliminar este producto' : 'Eliminar Producto'" class="p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition disabled:opacity-50" aria-label="Eliminar Producto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                }

                <div>
                    <button type="button" class="btn btn-outline btn-sm" (click)="addProduct()">+ Agregar producto</button>
                </div>
            </div>
        </section>

    </form>

    <shared-loading></shared-loading>
</div>
<shared-loading></shared-loading>
